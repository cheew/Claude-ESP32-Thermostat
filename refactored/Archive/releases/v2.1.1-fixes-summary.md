# v2.1.1 Bug Fixes Summary

**Date:** January 12, 2026
**Status:** Ready for testing
**Flash Usage:** 89.0% (1,166,873 bytes)

---

## ‚úÖ Issues Fixed

### 1. Schedule Page Not Displaying Slots

**Problem:**
- Schedule page only showed dropdown selector
- No schedule slots were rendered
- JavaScript couldn't find the days field

**Root Cause:**
- API endpoint `/api/output/{id}` was missing `days` field in schedule JSON
- Field name inconsistency (`target` vs `targetTemp`)

**Fix:**
- Added `slot["days"] = output->schedule[i].days;` to API response
- Fixed field name to `targetTemp` for consistency
- File: [src/network/web_server.cpp:1456](src/network/web_server.cpp#L1456)

**Result:**
- Schedule page now displays all 8 slots per output
- Time, temperature, and day selectors all working
- Color-coded active/inactive slots

---

### 2. Temperature Sliders Added

**Problem:**
- User wanted intuitive slider controls
- Need safe temperature zone (15-35¬∞C)
- Need override for advanced users (15-45¬∞C)

**Implementation:**
- Replaced number input with interactive range slider
- Safe zone: 15-35¬∞C (green color-coded label)
- Override checkbox: Extends to 45¬∞C with warning (‚ö†Ô∏è orange)
- Real-time display updates as slider moves
- Hidden number input synced with slider value

**Features:**
- Visual feedback with color coding
- 0.5¬∞C step increments
- Safety: Prevents accidental extreme temps
- Console logging when safe zone overridden
- Slider value loads correctly from API

**Files Modified:**
- [src/network/web_server.cpp:170-182](src/network/web_server.cpp#L170-L182) - HTML/UI
- [src/network/web_server.cpp:145-158](src/network/web_server.cpp#L145-L158) - JavaScript functions

---

### 3. Dark Mode Styling Improvements

**Problems:**
- Dark mode button had inconsistent height with other navigation buttons
- Low contrast text in dark mode (hard to read)
- Some elements had poor visibility

**Fixes:**

#### Button Height Fix:
- Moved `.theme-toggle` CSS definition before dark mode overrides
- Added `height:auto` to prevent height mismatches
- Ensured consistent padding across all screen sizes

#### Contrast Improvements:
- **Background:** Changed from `#1a1a1a` ‚Üí `#121212` (darker)
- **Container:** Changed from `#2d2d2d` ‚Üí `#1e1e1e` (better separation)
- **Text:** Improved all text colors:
  - H2/H3: `#f0f0f0` (was `#b0b0b0`)
  - Paragraphs: `#d0d0d0` (was default)
  - Labels: `#f0f0f0` (was default)
  - Stat labels: `#d0d0d0` (was `#b0b0b0`)
  - Log entries: `#d0d0d0` (better readability)

- **Form Elements:**
  - Inputs/selects: `#2d2d2d` background, `#f0f0f0` text
  - Better border contrast: `#4d4d4d`
  - Placeholder text: `#808080`

- **Info/Warning Boxes:**
  - Info: `#d0f0ff` text (was `#e0e0e0`)
  - Warning: `#ffe0a0` text (was `#e0e0e0`)

- **Navigation:**
  - Better hover color: `#2d6fa0` (was `#163c5f`)
  - Consistent across all buttons

**File:** [src/network/web_server.cpp:1774-1804](src/network/web_server.cpp#L1774-L1804)

---

## üîç MQTT Discovery Investigation

**Status:** Already implemented correctly

**What's Working:**
- MQTT discovery messages ARE being sent
- Sends 3 climate entity configs (one per output)
- Sends on first MQTT publish after connection
- Uses correct Home Assistant discovery format

**Discovery Topics:**
```
homeassistant/climate/reptile_thermostat_01_output1/config
homeassistant/climate/reptile_thermostat_01_output2/config
homeassistant/climate/reptile_thermostat_01_output3/config
```

**Each Entity Includes:**
- Unique ID: `reptile_thermostat_01_output1` (etc.)
- Name: Output name + device name
- All required topics (temp, setpoint, mode)
- Device info (groups all under "ESP32-Thermostat")
- Temperature limits (15-45¬∞C, 0.5¬∞ steps)
- Modes: off, heat

**Additional Sensors:**
- WiFi RSSI sensor
- Free memory sensor

**Troubleshooting If Not Seeing Entities:**

1. **Check MQTT Connection:**
   - Go to Settings page: `http://192.168.1.236/settings`
   - Verify broker IP, port, username, password
   - Check console: `http://192.168.1.236/console`
   - Look for "MQTT connected" events

2. **Check Discovery Messages Sent:**
   - Look in console for: "Sending Home Assistant discovery (multi-output)"
   - Should happen once after first MQTT publish

3. **Home Assistant Side:**
   - Verify MQTT integration is enabled
   - Check Configuration ‚Üí Integrations ‚Üí MQTT
   - Enable discovery prefix: `homeassistant`
   - Restart Home Assistant if needed
   - Check MQTT logs in HA

4. **MQTT Broker Logs:**
   - Check if discovery messages are actually received
   - Use MQTT Explorer or similar tool to see topics

5. **Force Rediscovery:**
   - Restart ESP32 (will send discovery again on boot)
   - Or: Power cycle device

**Code Location:**
- Discovery function: [src/network/mqtt_manager.cpp:350-460](src/network/mqtt_manager.cpp#L350-L460)
- Called from: [src/main.cpp:225](src/main.cpp#L225)

---

## ‚è≥ Auto-Update Issue

**Status:** Not yet investigated

**Problem:**
- Auto-update detects new version on GitHub
- Download/install fails

**Next Steps:**
1. Check GitHub repository settings
2. Verify firmware.bin is being published
3. Check download URL format
4. Test HTTPS connection from ESP32
5. Review error messages in console

**File to Check:** [src/network/web_server.cpp](src/network/web_server.cpp) - auto-update functions

---

## üì¶ Build Information

**Compilation:**
- ‚úÖ Build successful
- No warnings or errors

**Memory Usage:**
- **Flash:** 89.0% (1,166,873 / 1,310,720 bytes)
  - Increased from 88.8% (added features + improved CSS)
  - Still 144 KB free for future features
- **RAM:** 20.0% (65,584 / 327,680 bytes)
  - Unchanged
  - 262 KB free

**Changes Since v2.1.0:**
- Fixed schedule API (+50 bytes)
- Added temperature sliders (+~800 bytes CSS + JS)
- Improved dark mode styling (+~900 bytes CSS)
- **Total:** ~1,750 bytes added

---

## üß™ Testing Checklist

### Schedule Page:
- [ ] Navigate to Schedule page
- [ ] Select Output 1, 2, 3 from dropdown
- [ ] Verify 8 slots display for each output
- [ ] Check time inputs work (hour 0-23, minute 0-59)
- [ ] Check temperature inputs work (15-45¬∞C)
- [ ] Check day checkboxes toggle correctly
- [ ] Save schedule and reload page to verify persistence

### Temperature Sliders:
- [ ] Go to Outputs page
- [ ] Select each output (1, 2, 3)
- [ ] Move slider - verify display updates in real-time
- [ ] Verify slider range is 15-35¬∞C (safe zone)
- [ ] Check "Override Safe Zone" checkbox
- [ ] Verify slider extends to 45¬∞C
- [ ] Verify console log message appears
- [ ] Uncheck override - verify slider resets to 35¬∞C max
- [ ] Save control and verify temperature is applied

### Dark Mode:
- [ ] Toggle dark mode on
- [ ] Check all pages (Home, Outputs, Sensors, Schedule, Settings)
- [ ] Verify text is readable (good contrast)
- [ ] Check dark mode button is same height as other nav buttons
- [ ] Verify info boxes are readable
- [ ] Check form inputs have good contrast
- [ ] Test on mobile (if possible)
- [ ] Toggle back to light mode - verify works

### MQTT Discovery:
- [ ] Configure MQTT broker in Settings
- [ ] Save and restart ESP32
- [ ] Check console for "MQTT connected" and "Sending HA discovery"
- [ ] Open Home Assistant
- [ ] Check Integrations ‚Üí MQTT ‚Üí Devices
- [ ] Look for "ESP32-Thermostat" device
- [ ] Verify 3 climate entities appear
- [ ] Check entity names match output names
- [ ] Test controlling from Home Assistant

---

## üöÄ Next Steps

1. **Test v2.1.1 fixes** (user testing)
2. **Investigate auto-update issue** (if needed)
3. **Minor polish** (if any issues found)
4. **Release v2.1.1** (if all tests pass)

---

## üìù Files Modified

### Core Changes:
- [src/network/web_server.cpp](src/network/web_server.cpp)
  - Lines 1448-1457: Schedule API fix
  - Lines 168-182: Temperature slider UI
  - Lines 115-128: Load output function (slider sync)
  - Lines 145-158: Slider JavaScript functions
  - Lines 1774-1804: Dark mode CSS improvements

### No Changes Needed:
- [src/network/mqtt_manager.cpp](src/network/mqtt_manager.cpp) - Already correct
- [src/main.cpp](src/main.cpp) - Discovery already called

---

**Version:** 2.1.1
**Ready for Upload:** Yes
**Build Status:** ‚úÖ Success
